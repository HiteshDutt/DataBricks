name: Azure Data Factory

on:
  push:
    paths:
      - 'ADFIntegration/**'
    branches:
    - dev
    - main

env:
  folderwithpackagedotjsonfile: ADFIntegration/DevOpsFiles
  subscription: d33e1d84-2e9a-471b-be9c-560633380015
  resourceGroup: ADF
  dataFactory: adfgithubactions

jobs:
  Build:
    name: Build Stage
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      name: Checkout
    - name: Install Node.js
      uses: actions/setup-node@v1
      with:
        node-version: 10.x
    - name: Install npm package
      working-directory: ${{ github.workspace }}/${{ env.folderwithpackagedotjsonfile  }}
      run: npm install
    - name: Validate
      working-directory: ${{ github.workspace }}/${{ env.folderwithpackagedotjsonfile  }} 
      run: npm run build validate ${{ github.workspace }}/ADFIntegration /subscriptions/${{ env.subscription  }}/resourceGroups/${{ env.resourceGroup  }}/providers/Microsoft.DataFactory/factories/${{ env.dataFactory  }} ${{ github.workspace }}/${{ env.folderwithpackagedotjsonfile  }}
    - name: Generate ARM template
      working-directory: ${{ github.workspace }}/${{ env.folderwithpackagedotjsonfile  }} 
      run: npm run build export ${{ github.workspace }}/ADFIntegration /subscriptions/${{ env.subscription  }}/resourceGroups/${{ env.resourceGroup  }}/providers/Microsoft.DataFactory/factories/${{ env.dataFactory  }} "ArmTemplates" ${{ github.workspace }}/${{ env.folderwithpackagedotjsonfile  }}
    - uses: actions/upload-artifact@v2
      with:
        path: ${{ github.workspace }}/ADFIntegration/DevOpsFiles/ArmTemplates
    
